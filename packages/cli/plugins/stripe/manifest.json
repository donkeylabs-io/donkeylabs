{
  "name": "stripe",
  "version": "1.0.0",
  "description": "Stripe payments integration with customers, subscriptions, checkout, webhooks, and usage billing",
  "dependencies": {
    "stripe": "^17.0.0"
  },
  "copy": [
    { "from": "plugin", "to": "src/plugins/stripe" }
  ],
  "register": {
    "plugin": "stripePlugin",
    "importPath": "./plugins/stripe",
    "configRequired": true
  },
  "envVars": [
    "STRIPE_SECRET_KEY",
    "STRIPE_WEBHOOK_SECRET",
    "STRIPE_SUCCESS_URL",
    "STRIPE_CANCEL_URL",
    "STRIPE_PORTAL_RETURN_URL"
  ],
  "instructions": [
    "1. Install the Stripe SDK:",
    "",
    "   bun add stripe",
    "",
    "2. Register the plugin in your server setup:",
    "",
    "   import { stripePlugin } from './plugins/stripe';",
    "",
    "   server.registerPlugin(stripePlugin({",
    "     secretKey: process.env.STRIPE_SECRET_KEY!,",
    "     webhookSecret: process.env.STRIPE_WEBHOOK_SECRET!,",
    "     checkout: {",
    "       successUrl: process.env.STRIPE_SUCCESS_URL!,",
    "       cancelUrl: process.env.STRIPE_CANCEL_URL!,",
    "       allowPromotionCodes: true,",
    "     },",
    "     portal: {",
    "       returnUrl: process.env.STRIPE_PORTAL_RETURN_URL!,",
    "     },",
    "   }));",
    "",
    "3. Run migrations:",
    "",
    "   bun run migrate",
    "",
    "4. Create routes using the provided schemas:",
    "",
    "   import { createRouter } from '@donkeylabs/server';",
    "   import { stripeSchemas, createWebhookHandler } from './plugins/stripe/handlers';",
    "",
    "   const api = createRouter('api');",
    "",
    "   // Create checkout session",
    "   api.route('stripe.checkout').typed({",
    "     input: stripeSchemas.createSubscriptionCheckout.input,",
    "     output: stripeSchemas.createSubscriptionCheckout.output,",
    "     handle: async (input, ctx) => {",
    "       return ctx.plugins.stripe.createSubscriptionCheckout({",
    "         userId: ctx.userId,",
    "         ...input,",
    "       });",
    "     },",
    "   });",
    "",
    "   // Webhook endpoint (must be raw for signature verification)",
    "   api.route('stripe.webhook').raw(createWebhookHandler());",
    "",
    "5. Configure webhook in Stripe Dashboard:",
    "",
    "   - Endpoint URL: https://your-domain.com/api/stripe.webhook",
    "   - Events to listen for:",
    "     - checkout.session.completed",
    "     - customer.subscription.created",
    "     - customer.subscription.updated",
    "     - customer.subscription.deleted",
    "     - invoice.paid",
    "     - invoice.payment_failed",
    "",
    "6. Use middleware for protected routes:",
    "",
    "   api.route('premium.feature').typed({",
    "     input: z.object({}),",
    "     output: z.object({ data: z.string() }),",
    "     middleware: [ctx.plugins.stripe.middleware.requireSubscription],",
    "     handle: async (input, ctx) => {",
    "       // Only accessible with active subscription",
    "       return { data: 'premium content' };",
    "     },",
    "   });",
    "",
    "See src/plugins/stripe/handlers/index.ts for all available schemas."
  ]
}
